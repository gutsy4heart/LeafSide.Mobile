# Подключение мобильного приложения к бэкенду

## Текущая конфигурация

### Бэкенд (ASP.NET Core)
- **URL**: `http://localhost:5233`
- **CORS**: Настроен для поддержки мобильных устройств (разрешает все источники)
- **Аутентификация**: JWT Bearer Token

### Мобильное приложение (Expo/React Native)
- **Конфигурация**: Файл `.env` содержит `EXPO_PUBLIC_API_URL`
- **По умолчанию**: `http://10.0.2.2:5233` (для Android эмулятора)

## Настройка .env файла

### Для Android эмулятора (по умолчанию):
```env
EXPO_PUBLIC_API_URL=http://10.0.2.2:5233
```

### Для iOS симулятора:
```env
EXPO_PUBLIC_API_URL=http://127.0.0.1:5233
```

### Для реального устройства:

1. Узнайте IP адрес вашего компьютера:
   ```powershell
   ipconfig
   # Найдите IPv4 адрес (например, 192.168.1.100)
   ```

2. Обновите .env:
   ```env
   EXPO_PUBLIC_API_URL=http://192.168.1.100:5233
   ```

3. Убедитесь, что бэкенд доступен по этому адресу:
   - Проверьте настройки файрвола Windows
   - Убедитесь, что телефон и компьютер в одной сети Wi-Fi

## API Endpoints

### Аутентификация
- `POST /api/Account/login` - вход
- `POST /api/Account/register` - регистрация
- `GET /api/Account/profile` - получение профиля
- `PUT /api/Account/profile` - обновление профиля
- `POST /api/Account/refresh` - обновление токена

### Книги
- `GET /api/Books` - список книг (без авторизации)
- `GET /api/Books/{id}` - детали книги (без авторизации)

### Корзина (требует авторизации)
- `GET /api/Cart` - получить корзину
- `POST /api/Cart/items` - добавить/обновить товар
- `DELETE /api/Cart/items/{bookId}` - удалить товар
- `DELETE /api/Cart` - очистить корзину

### Заказы (требует авторизации)
- `GET /api/orders` - список заказов пользователя
- `POST /api/orders` - создать заказ

### Статистика пользователя
- `GET /api/UserStats/stats` - статистика пользователя

## Проверка подключения

### 1. Убедитесь, что бэкенд запущен:
```powershell
cd LeafSide-backend
dotnet run --project LeafSide.API
```

Бэкенд должен быть доступен на `http://localhost:5233`

### 2. Проверьте доступность API:
```powershell
# В другом терминале
curl http://localhost:5233/api/health
# или
Invoke-WebRequest -Uri http://localhost:5233/api/health
```

### 3. Проверьте мобильное приложение:
```powershell
cd LeafSide.Mobile
npm start
```

### 4. Тестирование подключения:

После запуска мобильного приложения попробуйте:
- Зарегистрироваться или войти
- Просмотреть каталог книг
- Добавить книгу в корзину

## Решение проблем

### Ошибка CORS
- Убедитесь, что в `Program.cs` используется `MobilePolicy`
- Перезапустите бэкенд после изменений

### Не могу подключиться с реального устройства
- Проверьте, что устройство и компьютер в одной Wi-Fi сети
- Убедитесь, что Windows Firewall не блокирует порт 5233
- Проверьте IP адрес в .env файле

### Ошибка 401 Unauthorized
- Проверьте, что токен передается в заголовках
- Убедитесь, что токен не истек (60 минут по умолчанию)
- Используйте `/api/Account/refresh` для обновления токена

### Ошибка 404 Not Found
- Проверьте, что endpoint существует в бэкенде
- Убедитесь, что регистр пути правильный (хотя маршруты не чувствительны к регистру)

## Важные замечания

1. **CORS Policy**: Для разработки используется `MobilePolicy`, который разрешает все источники. Для продакшена следует ограничить разрешенные домены.

2. **HTTPS**: В продакшене используйте HTTPS для безопасности.

3. **Токены**: JWT токены истекают через 60 минут. Реализуйте автоматическое обновление токенов.

4. **Регистр путей**: ASP.NET Core маршруты по умолчанию не чувствительны к регистру, поэтому `/api/account` и `/api/Account` работают одинаково.

